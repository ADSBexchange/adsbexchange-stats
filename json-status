#!/bin/bash
#
# send dumpo1090 json to local or remote server for processing
#

REMOTE_URL="https://adsbexchange.com/api/receive/"

# dump1090-fa /run/dump1090-fa/
# adsbx /run/dump1090-mutability/
ADSBX_JSON="/run/dump1090-mutability/"
FA_JSON="/run/dump1090-fa/"

if [ -s $ADSBX_JSON ]; then
  JSON=$ADSBX_JSON
fi

if [ -s $FA_JSON ]; then
  JSON=$FA_JSON
fi

# no directories just bail
if [ -z "$JSON" ]; then
  echo "No Valid Directories Found. Exiting ..."
  exit 3
fi

# uuid
UUID_FILE="/boot/adsbx-uuid"
# look for uuid - if invalid or missing genrate one
if [ -s $UUID_FILE ]; then
        UUID=$(cat $UUID_FILE)
        if ! [[ $UUID =~ ^\{?[A-F0-9a-f]{8}-[A-F0-9a-f]{4}-[A-F0-9a-f]{4}-[A-F0-9a-f]{4}-[A-F0-9a-f]{12}\}?$ ]]; then
                # invalid - remove and regenerate
                rm -f $UUID_FILE
                UUID=$(uuidgen -t)
                echo $UUID > $UUID_FILE
        fi
else
        #not found generate uuid and write
        UUID=$(uuidgen -t)
        echo $UUID > $UUID_FILE
fi

# echo -e "starting dump1090 stats watcher"

inotifywait -q -m -e moved_to $JSON |
while read -r filename action file; do
  # echo -e "triggered event "$action $file
  # copy aircraft.json then get ready to do work

 if [ $file = "aircraft.json" ]; then
  if [ $action = "MOVED_TO" ]; then
  # echo $file ' ' $action 
  RAND=$(head /dev/urandom | tr -dc A-Za-z0-9 | head -c10)
  FILE_RAND="/var/run/json-${RAND}"
  FILE_RAND_NEW="/var/run/json-${RAND}-new"

  cp $JSON/aircraft.json $FILE_RAND
  # echo -e "copied "$FILE_RAND

  # echo -e "data sent compressed"
   #cat /tmp/$FILE_RAND | gzip | curl -s -o /dev/null -X POST -H "Content_Encoding: gzip" --data-binary @- $REMOTE_URL

  UUID=$(cat $UUID_FILE)
  echo '{"uuid":"'$UUID'",' > $FILE_RAND_NEW
  echo '"aircraft":' >> $FILE_RAND_NEW
  jq '.aircraft' $FILE_RAND >> $FILE_RAND_NEW
  echo '}' >> $FILE_RAND_NEW
  
  $(cat $FILE_RAND'x' | gzip | curl -s -o /dev/null -X POST -H "Content_Encoding: gzip" --data-binary @- $REMOTE_URL) || true

  # clean up the tmp files created
  # echo -e "clean up "$FILE_RAND
  rm $FILE_RAND
  rm $FILE_RAND_NEW
  sleep 5
   fi
 fi
done
